plugins {
  id 'base'
  id 'com.github.node-gradle.node' version '3.0.1'
}

ext {
  dockerImageName = "165.22.227.230:5000/${project.name}"
}

repositories {
  mavenCentral()
}

node {
  version = '14.17.1'
  npmVersion = '7.17.0'
  download = true
}

task bundle(type: NpmTask, dependsOn: npmInstall) {
  args = ['run', 'build']
}

assemble.dependsOn(bundle)

task test(type: NpmTask) {
  environment = ['CI': 'true']
  args = ['run', 'test']
}

check.dependsOn(test)

task buildDockerImage(type: Exec) {
  dependsOn test

  commandLine 'docker', 'build', '-t', "${dockerImageName}", '.'
}

task publishDockerImage(type: Exec) {
  dependsOn buildDockerImage

  commandLine 'docker', 'push', "${dockerImageName}"
}